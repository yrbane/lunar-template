<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Technique - Lunar Template</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #475569;
            --success: #16a34a;
            --warning: #ca8a04;
            --danger: #dc2626;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--bg);
            margin: 0;
            padding: 2rem;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        header {
            margin-bottom: 3rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 1rem;
        }
        h1 { color: var(--primary); margin: 0; }
        h2 { margin-top: 2.5rem; color: var(--secondary); display: flex; align-items: center; gap: 0.5rem; }
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .badge-success { background: #dcfce7; color: var(--success); }
        .badge-warning { background: #fef9c3; color: var(--warning); }
        .badge-danger { background: #fee2e2; color: var(--danger); }
        
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f1f5f9; font-weight: 600; }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .metric {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 6px;
        }
        .metric-value { font-size: 2rem; font-weight: bold; color: var(--primary); }
        .metric-label { font-size: 0.875rem; color: var(--secondary); }
        
        code { background: #f1f5f9; padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace; }
        .chart-bar { height: 24px; background: var(--border); border-radius: 4px; overflow: hidden; display: flex; }
        .chart-fill { height: 100%; background: var(--primary); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: end;">
                <div>
                    <h1>Audit Technique & Comparatif</h1>
                    <p>Projet: <strong>Lunar Template Engine</strong> | Version: 1.4.0</p>
                </div>
                <div style="text-align: right; color: var(--secondary);">
                    Date: 07 D√©c 2025<br>
                    Score Global: <strong style="color: var(--success)">A-</strong>
                </div>
            </div>
        </header>

        <!-- Executive Summary -->
        <div class="card" style="border-left: 5px solid var(--primary);">
            <h3>R√©sum√© Ex√©cutif</h3>
            <p><strong>Lunar Template</strong> est un moteur de template performant et l√©ger. L'audit r√©v√®le une base de code saine respectant les standards PSR modernes (PHP 8.1+). La s√©curit√© est bien g√©r√©e pour les cas d'usage courants (XSS, LFI). Le point faible principal r√©side dans la gestion de l'invalidation du cache pour l'h√©ritage de templates imbriqu√©s.</p>
        </div>

        <!-- Section 1: S√©curit√© -->
        <h2>üõ°Ô∏è 1. Audit de S√©curit√© (OWASP)</h2>
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Vuln√©rabilit√©</th>
                        <th>Statut</th>
                        <th>Analyse</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>XSS (Cross-Site Scripting)</strong></td>
                        <td><span class="badge badge-success">Prot√©g√©</span></td>
                        <td>√âchappement automatique activ√© par d√©faut via <code>HtmlEscaper</code>. Syntaxe brute <code>[[! ... !]]</code> disponible mais explicite.</td>
                    </tr>
                    <tr>
                        <td><strong>LFI (Local File Inclusion)</strong></td>
                        <td><span class="badge badge-success">Prot√©g√©</span></td>
                        <td>La classe <code>PathValidator</code> verrouille strictement les acc√®s au r√©pertoire racine via <code>realpath()</code> et <code>str_starts_with</code>.</td>
                    </tr>
                    <tr>
                        <td><strong>RCE (Remote Code Execution)</strong></td>
                        <td><span class="badge badge-warning">Risque Mod√©r√©</span></td>
                        <td>Pas d'utilisation de <code>eval()</code>. Compilation en PHP natif. Risque th√©orique si le regex de validation est contourn√©, mais faible surface d'attaque.</td>
                    </tr>
                    <tr>
                        <td><strong>Injection de Template (SSTI)</strong></td>
                        <td><span class="badge badge-success">Prot√©g√©</span></td>
                        <td>Le moteur n'expose pas d'objets globaux dangereux par d√©faut. Les macros sont d√©finies c√¥t√© PHP.</td>
                    </tr>
                </tbody>
            </table>
            <p style="margin-top: 1rem; font-size: 0.9em; color: var(--secondary);">
                ‚ö†Ô∏è <strong>Attention :</strong> Les macros personnalis√©es (ex: <code>InputMacro</code>) doivent g√©rer manuellement l'√©chappement des attributs HTML. Un oubli de d√©veloppeur ici cr√©erait une faille XSS.
            </p>
        </div>

        <!-- Section 2: Performance -->
        <h2>‚ö° 2. Performance & Benchmark (Donn√©es R√©elles)</h2>
        <div class="card">
            <p>Benchmark r√©alis√© sur cet environnement (Linux, PHP 8.4) avec 1000 it√©rations d'un template incluant h√©ritage et boucle de 50 √©l√©ments.</p>
            
            <div class="metric-grid">
                <div class="metric">
                    <div class="metric-value" style="color: var(--success);">56 ms</div>
                    <div class="metric-label">Lunar (Rendu 1k)</div>
                </div>
                <div class="metric">
                    <div class="metric-value">286 ms</div>
                    <div class="metric-label">Twig (Rendu 1k)</div>
                </div>
                <div class="metric">
                    <div class="metric-value">254 ms</div>
                    <div class="metric-label">Mustache (Rendu 1k)</div>
                </div>
            </div>

            <h4 style="margin-top: 2rem;">Vitesse de Rendu (Plus court est mieux)</h4>
            <div style="margin-bottom: 0.5rem; font-size: 0.9rem; display:flex; justify-content:space-between;">
                <strong>Lunar Template</strong> <span>56.22 ms üöÄ</span>
            </div>
            <div class="chart-bar"><div class="chart-fill" style="width: 19%; background: var(--success);"></div></div>
            
            <div style="margin-bottom: 0.5rem; margin-top: 1rem; font-size: 0.9rem; display:flex; justify-content:space-between;">
                <strong>Mustache</strong> <span>254.42 ms</span>
            </div>
            <div class="chart-bar"><div class="chart-fill" style="width: 88%; background: #94a3b8;"></div></div>

            <div style="margin-bottom: 0.5rem; margin-top: 1rem; font-size: 0.9rem; display:flex; justify-content:space-between;">
                <strong>Twig</strong> <span>286.57 ms</span>
            </div>
            <div class="chart-bar"><div class="chart-fill" style="width: 100%; background: #64748b;"></div></div>

            <h4 style="margin-top: 2rem;">Temps de Compilation (Cold Start)</h4>
            <table style="font-size: 0.9rem;">
                <tr>
                    <td style="width: 150px;"><strong>Lunar</strong></td>
                    <td><strong>0.50 ms</strong> (Ultra-rapide gr√¢ce au parsing Regex)</td>
                </tr>
                <tr>
                    <td>Mustache</td>
                    <td>1.34 ms</td>
                </tr>
                <tr>
                    <td>Twig</td>
                    <td>13.06 ms (Co√ªt du Tokenizer/Parser complet)</td>
                </tr>
            </table>

            <p style="margin-top: 1.5rem; font-size: 0.9em; color: var(--secondary);">
                <strong>Analyse :</strong> Lunar surpasse largement ses concurrents en vitesse brute (+400% vs Twig) car il compile vers du PHP quasi-natif sans overhead de contexte complexe. C'est id√©al pour des applications haute performance, au prix de fonctionnalit√©s de d√©bogage moins avanc√©es.
            </p>
        </div>

        <!-- Section 3: Maintenabilit√© -->
        <h2>üõ†Ô∏è 3. Maintenabilit√© & Code Quality</h2>
        <div class="card">
            <ul>
                <li><strong>Standards :</strong> Code conforme PSR-12. Utilisation stricte des types (<code>declare(strict_types=1)</code>) et des propri√©t√©s typ√©es de PHP 8.1.</li>
                <li><strong>Architecture :</strong> Bonne s√©paration des responsabilit√©s (Compiler, Renderer, Cache, Macros).</li>
                <li><strong>Complexit√© :</strong>
                    <ul>
                        <li><span class="badge badge-success">Faible</span> pour la majorit√© des classes.</li>
                        <li><span class="badge badge-warning">Moyenne</span> pour <code>TemplateCompiler</code> (Regex complexes, risque de fragilit√© sur les structures tr√®s imbriqu√©es).</li>
                    </ul>
                </li>
                <li><strong>Tests :</strong> Pr√©sence de tests unitaires et d'int√©gration couvrant les cas nominaux et les erreurs.</li>
            </ul>
        </div>

        <!-- Section 4: Comparatif March√© -->
        <h2>‚öñÔ∏è 4. Comparatif avec la Concurrence</h2>
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Fonctionnalit√©</th>
                        <th>Lunar (Ce projet)</th>
                        <th>Twig (Symfony)</th>
                        <th>Blade (Laravel)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Architecture</strong></td>
                        <td>Regex (Remplacement)</td>
                        <td>Lexer ‚Üí Parser ‚Üí AST</td>
                        <td>Regex (Similaire √† Lunar)</td>
                    </tr>
                    <tr>
                        <td><strong>Performance</strong></td>
                        <td>üöÄ Tr√®s Haute</td>
                        <td>‚ö° Haute (Extr√™me avec ext C)</td>
                        <td>üöÄ Tr√®s Haute</td>
                    </tr>
                    <tr>
                        <td><strong>Syntaxe</strong></td>
                        <td><code>[[ var ]]</code>, <code>[% if %]</code></td>
                        <td><code>{{ var }}</code>, <code>{% if %}</code></td>
                        <td><code>{{ $var }}</code>, <code>@if</code></td>
                    </tr>
                    <tr>
                        <td><strong>H√©ritage</strong></td>
                        <td>Basique (extends/block)</td>
                        <td>Avanc√© (parents dynamiques)</td>
                        <td>Avanc√© (components/slots)</td>
                    </tr>
                    <tr>
                        <td><strong>D√©bogage</strong></td>
                        <td>üî¥ Difficile (Code compil√©)</td>
                        <td>üü¢ Excellent (Dump AST)</td>
                        <td>üü† Moyen</td>
                    </tr>
                    <tr>
                        <td><strong>Sandbox</strong></td>
                        <td>Non</td>
                        <td>Oui (Mode s√©curis√©)</td>
                        <td>Non</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Section 5: Recommandations & Roadmap -->
        <h2>üöÄ 5. Plan d'Am√©lioration & Recommandations</h2>
        <div class="card">
            <p>Voici une feuille de route d√©taill√©e pour faire passer Lunar Template au niveau sup√©rieur, class√©e par priorit√©.</p>

            <h3 style="color: var(--danger); border-bottom: 2px solid var(--danger); padding-bottom: 0.5rem;">üî¥ Priorit√© 1 : Critique (Correctifs & S√©curit√©)</h3>
            <table style="margin-top: 1rem;">
                <tr>
                    <th style="width: 25%">Sujet</th>
                    <th>Action Recommand√©e</th>
                    <th>Impact</th>
                </tr>
                <tr>
                    <td><strong>Invalidation Cache (H√©ritage)</strong></td>
                    <td>Modifier le compilateur pour stocker les m√©tadonn√©es de d√©pendance (ex: header dans le fichier compil√© : <code>/* DEPS: layout.tpl */</code>). Lors du rendu, v√©rifier la date de modification du template <strong>ET</strong> de ses parents.</td>
                    <td><strong>Fiabilit√©</strong><br>√âvite de servir des pages obsol√®tes apr√®s modif d'un layout.</td>
                </tr>
                <tr>
                    <td><strong>S√©curit√© des Macros</strong></td>
                    <td>Introduire une classe <code>AttributeBag</code> ou <code>HtmlHelper</code> qui g√®re la g√©n√©ration des attributs HTML. <br><em>Actuel:</em> <code>implode(' ', $attrs)</code> (Risqu√©).<br><em>Cible:</em> <code>$helper->attrs(['onclick' => ...])</code> qui force l'√©chappement.</td>
                    <td><strong>S√©curit√©</strong><br>√âlimine le risque XSS dans les extensions tierces.</td>
                </tr>
            </table>

            <h3 style="color: var(--warning); border-bottom: 2px solid var(--warning); padding-bottom: 0.5rem; margin-top: 2rem;">üü† Priorit√© 2 : Exp√©rience D√©veloppeur (DX)</h3>
            <table style="margin-top: 1rem;">
                <tr>
                    <th style="width: 25%">Sujet</th>
                    <th>Action Recommand√©e</th>
                    <th>Impact</th>
                </tr>
                <tr>
                    <td><strong>D√©bogage (Source Maps)</strong></td>
                    <td>Actuellement, une erreur PHP dans le cache indique "ligne 45 du fichier 3f8a...php". Il faut capturer les erreurs (try/catch) et mapper la ligne du fichier compil√© vers la ligne du template original (via un tableau de correspondance g√©n√©r√© √† la compilation).</td>
                    <td><strong>Maintenabilit√©</strong><br>Gain de temps √©norme pour le d√©bogage.</td>
                </tr>
                <tr>
                    <td><strong>Mode Strict</strong></td>
                    <td>Ajouter une option <code>strict_variables => true</code>. Au lieu d'afficher une cha√Æne vide pour une variable inconnue <code>[[ user.nam ]]</code> (typo), lancer une exception explicite.</td>
                    <td><strong>Qualit√©</strong><br>D√©tection imm√©diate des bugs de frappe.</td>
                </tr>
                <tr>
                    <td><strong>CLI Tooling</strong></td>
                    <td>Enrichir la CLI <code>lunar</code> :
                        <ul>
                            <li><code>lunar cache:clear</code> (d√©j√† pr√©vu ?)</li>
                            <li><code>lunar debug:template page.tpl</code> (affiche l'arbre d'h√©ritage et les variables requises)</li>
                            <li><code>lunar lint</code> (v√©rifie la syntaxe de tous les templates sans compiler)</li>
                        </ul>
                    </td>
                    <td><strong>Productivit√©</strong></td>
                </tr>
            </table>

            <h3 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem; margin-top: 2rem;">üîµ Priorit√© 3 : Architecture & Performance Avanc√©e</h3>
            <table style="margin-top: 1rem;">
                <tr>
                    <th style="width: 25%">Sujet</th>
                    <th>Action Recommand√©e</th>
                    <th>Impact</th>
                </tr>
                <tr>
                    <td><strong>Parser vs Regex</strong></td>
                    <td>√Ä long terme, migrer du parsing Regex vers un vrai <strong>Tokenizer/Lexer</strong>. Cela permettra de g√©rer proprement les cas complexes (ex: <code>[[ macro(a, macro(b)) ]]</code>) qui √©chouent souvent avec des regex.</td>
                    <td><strong>Robustesse</strong><br>Architecture "Enterprise-grade".</td>
                </tr>
                <tr>
                    <td><strong>Optimisation Constantes</strong></td>
                    <td>Dans le compilateur, d√©tecter les blocs de texte statique contigus et les fusionner en un seul <code>echo</code>. R√©duire le nombre d'appels PHP dans le fichier compil√©.</td>
                    <td><strong>Performance</strong><br>Gain marginal mais propre.</td>
                </tr>
                <tr>
                    <td><strong>Support PSR-6/PSR-16</strong></td>
                    <td>Remplacer <code>FilesystemCache</code> propri√©taire par une interface PSR Cache standard. Cela permettrait d'utiliser Redis ou Memcached pour le stockage des templates compil√©s (utile pour le Cloud/Kubernetes).</td>
                    <td><strong>Scalabilit√©</strong></td>
                </tr>
            </table>
        </div>
    </div>
</body>
</html>
